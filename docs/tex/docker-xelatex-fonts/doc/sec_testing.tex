\pagebreak
\section{ПРОГРАММА И МЕТОДИКА ИСПЫТАНИЙ}
\label{sec:testing}

\section{Юнит тестирование}

Для запуска тестов необходимо запустить скрипт \texttt{test.sh}.
С помощью данного скрипта вызывается докер, в котором разворачивается вся необходимая инфраструктура, а также и разработанные компоненты системы.
В качестве интеграционного теста происходит проверка отправки и получения сообщений, которые передаются с помощью kafka.

С помощью докера запускаются следующие компоненты:
\begin{itemize}
    \item zookeeper;
    \item kafka;
    \item отправитель.
\end{itemize}

Отправитель использует настройки для тестирования.
Однако, для взаимодействия со внешним сервисом необходим ключ, что уже было отмечено раньше.
По этой причине, ключ передаётся в качестве аргумента при запуске скрипта \texttt{test.sh}.
Скрипт подменяет значение по-умолчанию в файле конфигурации.
Таким образом, появляется возможность запускать интеграционные тесты с помощью скрипта.

Также, при использовании средств непрерывной интеграции появляется возможность задать такой ключ прямо в настройках пайплайна.
По этой причине, в качестве аргумента для скрипта \texttt{test.sh} в jenkinsfile используется переменная окружения:
\begin{lstlisting}
    sh "./test.sh --api-key ${OPEN_WEATHER_MAP_API_KEY}"
\end{lstlisting}

Данное значение устанавливается в самих настройках пайплайна в jenkins.
Такой подход позволяет скрыть действительно используемый API ключ от других участников проекта.
В свою очередь каждый участник сможет использовать свой собственный ключ для тестирования, либо для использования проекта.

После того, как все компоненты были запущены, отправитель перебирает установленный диапазон параметров, и пытается получить для них данные.
Всё действует точно также, как и при настоящей работе программы: сначала происходит проверка локального хранилища, а в случае отсутствия данных - происходит обращение к внешнему сервису.
Все отправленные сообщения отправляются в топик для тестирования.
Это позволяет при желании использовать тот же kafka брокер, который будет использоваться и при работе программы.
В таком случае, происходит тестирование продукта в <<полевых>> условиях.

После того, как сообщения были отправлены в брокер, отдельный получатель проверяет количество сообщений в тестовом топике.
Количество сообщений должно совпадать с диапазоном значений, который был использован при отправлении значений.
Если же количество сообщений не совпадает - значит какие-то данные не были отправлены в топик.
Это означает, что такая система не может полноценно работать, поэтому использование текущего окружения и настроек приведёт к ошибочному поведению программы.

Такое тестирование позволяет уловить само наличие ошибок, однако не предоставляет точной информации, в какой именно части произошёл сбой.
Поэтому, при тестировании ведётся логгирование программы, что позволяет отследить полный ход программы.
Возможные причины отсутствия сообщений:
\begin{itemize}
    \item недоступность kafka-брокера;
    \item используемый топик не был создан;
    \item был указан неверный путь к локальному хранилищу;
    \item был указан неверный API-ключ;
    \item используемый API-ключ не имеет необходимой подписки для использования API для получения индекса загрязнений;
    \item отсутствие связи с сервером;
    \item неработоспособность zookeeper сервера;
    \item используемый порт уже используется другим приложением;
    \item недоступный удалённый адрес распределённой системы при использовании таковой;
    \item системные ошибки.
\end{itemize}

К системным ошибкам относятся недостаток свободного места на диске, нехватка оперативной памяти, принудительное завершение процесса и тому подобное.
Остальные ошибки можно распознать при чтении log-файла.


\section{Юнит тестирование}

